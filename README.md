# デジタルフィルタ設計 1章
## 前書き
研究で使うデジタルフィルタの設計を行うために最低限必要な知識をまとめたページです。<br>
フィルタに関して、少し理解している程度でよく分かっていないので、間違いもあると思います。ご指摘も含めよろしくお願いします。<br>



## デジタルフィルタの種類
* LPF(ローパスフィルタ)
  * 低周波を通して高周波をカット。
* HPF(ハイパスフィルタ)
  * 高周波を通して低周波をカット 。
* BPF(バンドパスフィルタ)
  * 〇〇Hz~△△Hzのみ通す。それ以外はカット。
* Notch Filter(ノッチフィルタ)
  * ◻︎◻︎Hzのみカット。それ以外を通す。


## デジタルフィルタのグラフの見方
図1の上図は、縦軸は大きさ(dB)、横軸は周波数(Hz)のグラフで、フィルタの特性を示しています。<br>
dBから振幅の大きさに変換する式は、"振幅倍率 = 10^( dB値 / 20)"です。<br>
つまり、0dBで1倍、-3dBで0.7079457844倍、-6dBで0.5011872336倍、-9dBで0.3548133892倍、-12dBで0.2511886432倍、...、-20dBで0.1000000000倍となります。<br>
カットオフ周波数とは-3dBになるところをいい、図のLPFのカットオフ周波数は20Hzとなります。
<br>
図1の下図は、縦軸は振幅、横軸は時間(ms)のグラフで、入力信号と出力信号の関係を示しています。
入力データは、正弦波30Hzに対し、カットオフ周波数20HzのLPFを掛けた結果です。約0.4倍の振幅になっていることが確認できます。周波数特性のグラフを確認すると、30Hzのところで-8dBです。計算してみると、" 振幅倍率 = 10^( -8 / 20) = 0.398倍 "と一致します。
<br>
また、今回例に挙げたフィルタでは、信号の減衰だけでなく遅延も確認できます。これは、設計によって遅延が限りなく0に近いか、どのような特徴があるかなど考慮して設計する必要があります。詳しくは後に書いてあります。

<div align="center">

![ex1](./img/ex1.png)
図1. 周波数特性と時系列グラフ
</div><br>








## デジタルフィルタの構造の種類と特徴

### 種類

* IIR (Infinite Impulse Response)
  * 出力は入力の畳み込み和だけでなく、過去の出力の畳み込み和も使って計算
* FIR (Finite Impulse Response)
  * 出力は入力の畳み込み和でのみ計算


### 特徴

#### 位相
|  | IIR (Infinite Impulse Response) | FIR (Finite Impulse Response) |
| :-- | :-: | :-: |
| 位相 | 線形になりにくい | 線形になりやすい |


今回の位相とは、周波数毎にどのくらい信号が遅延するかを示すものです。<br>
線形ということは、どの周波数の信号であっても遅延が一定に近いということです。逆に線形でない時は、10Hz信号は1ms出力で遅延に対し、30Hz信号は10ms出力で遅延するように一定ではないです。実際に図3を見ればわかるとおり、FIRの遅延は一定であるのに対し、IIRは一定ではないです。

<div align="center">

![周波数特性](./img/1.png)
図2. BPF(100~200Hz)の周波数特性
</div><br>

<div align="center">

![遅延特性](./img/2.png)
図3. BPF(100~200Hz)の遅延
</div><br>


#### 安定性

|  | IIR (Infinite Impulse Response) | FIR (Finite Impulse Response) |
| :-: | :-: | :-: |
| 安定性 | 設計次第 | 安定 |

これは、あまり理解できていないのですが、FIRは常に安定で、IIRの場合は|極|<1.0である時に安定するようです。図4のようなグラフを作成して、円内に収まれば安定、円外で不安定と判別できます。極を求める手順は図5の通りです。<br>

<div align="center">

![z計算](./img/3.png)
図4. zのグラフ
</div><br>

<div align="center">

![z計算](./img/4.png)
図5. zの求め方(ChatGPT)
</div><br>


#### Q(共振の鋭さ)

|  | IIR (Infinite Impulse Response) | FIR (Finite Impulse Response) |
| :-: | :-: | :-: |
| Q(共振の鋭さ) | 定義あり | 定義なし |

Qとは、共振の鋭さを示すもので、Q値が高いとカットオフ周波数近傍が急になります。広範囲で見ると急さは同じです。IIRの時のみ考慮します。<br>
図6は次数2のLPFです。Qが高いとカットオフ周波数付近で緩急が急になっていることがわかります。しかし、350Hzあたりでは、同じ値に収束しています。<br>
また、Q値が0.7以上になると共振しています(0dBを超えて隆起している)。これは、2次のフィルタだと共振しないQ値が0.7以下となるからです。(フィルタ毎にQ値の上限は異なります)<br>

<div align="center">

![Q](./img/5.png)
図6. Q値
</div><br>


#### 遷移域の狭さ

|  | IIR (Infinite Impulse Response) | FIR (Finite Impulse Response) |
| :-: | :-: | :-: |
| 遷移域の狭さ | 狭くできる(特徴あり) | 狭くできる(特徴あり) |


遷移域とは、図7の周波数特性の黄色範囲部分のことを指します<br>
狭い遷移域をできるだけ少ない計算量・低遅延で実現したい場合、IIR（特に楕円/チェビシェフ）が有利です。<br>
位相直線性・波形忠実度や確実な安定性が最優先の場合FIR（equiripple/窓法）が有利です。ただしタップ数（＝遅延・計算量）が大きくなります。<br>
IIRで遷移域の狭くする場合、次数を増やす事で可能です。例を図8に示します。<br>
FIRで遷移域の狭くする場合、タップ数を増やす事で可能です。例を図9に示します。<br>

<div align="center">

![Q](./img/8.png)
図7. 遷移域とは
</div><br>




<div align="center">

![Q](./img/6.png)
図8. IIRフィルタの次数毎の周波数特性
</div><br>


<div align="center">

![Q](./img/7.png)
図9. FIRフィルタの次数毎の周波数特性
</div><br>


|  | IIR (Infinite Impulse Response) | FIR (Finite Impulse Response) |
| :-: | :-: | :-: |
| 計算量 | 少ない | 多い |



##  設計法選択
フィルタの設計には、数学で定義された設計規範があります。(らしい)<br>
IIRでは、Butterworth、 Chebyshev、 Elliptic、 Besselなどがあります。<br>
FIRでは、窓法、Parks–McClellan、最小二乗、周波数サンプリング法などがあります。



###  IIRの設計規範

| 優先事項                | よく選ばれる型             | 使われる場面・コメント                      |
| ------------------- | ------------------- | -------------------------------- |
| **無難で単調（ピークなし）**    | **Butterworth**     | 音響のトーン、一般計測。“まずはコレ”。次数はやや増える     |
| **低次数で鋭い遷移域**       | **Elliptic（Cauer）** | 組込み・制御・通信の前段など。最小次数だがリップル＆位相歪みあり |
| **通過帯の平坦性より急峻さ**    | **Chebyshev I**     | パスバンド等リップルを許容。Butterより低次数        |
| **通過帯は滑らか、阻止帯で頑張る** | **Chebyshev II**    | パスバンド平坦、阻止帯等リップル。測定系で好まれることも     |
| **過渡応答/位相（群遅延）最重視** | **Bessel**          | 立上り形状を守りたい計測・オーディオ前段。超緩やか＆高次数    |




###  FIRの設計規範

| 優先事項               | よく選ばれる設計法                          | 使われる場面・コメント                      |
| ------------------ | ---------------------------------- | -------------------------------- |
| **手早く安定・直感的**      | **窓法（Kaiser が定番）**                 | 粗設計・実装容易。Kaiser βでリップルと遷移域の調整が簡単 |
| **タップ数を最小級に**      | **Parks–McClellan（Equiripple）**    | 仕様どおりのリップル/減衰で最少タップに近い。通信・計測全般   |
| **線形位相で低コスト（半帯域）** | **Half-band FIR**                  | サンプリング変換(×2/÷2)で多用。係数の半分がゼロで軽い   |
| **ISI抑制・整形**       | **(Root-)Nyquist / Raised-cosine** | 通信（送受信整形フィルタ）。群遅延一定で符号間干渉を抑制     |
| **特殊相位相器**         | **Hilbert / Differentiator**       | 90°位相器や微分器。タイプIII/IV FIR で設計     |






## デジタルフィルタの設計手順
まず、IIRか、FIRかを決めます。




### FIRフィルタの設計手順
1. 設計法(窓法, Equirippleなど)を決める
2. カットオフ周波数、必要な遷移域幅を決める
3. タップ数を決める
4. 設計コードで設計する
5. 周波数特性、遅延グラフ、時系列グラフで問題ないか確認して完成

### IIRフィルタの設計手順
1. 設計法(Butterworth, Ellipticなど)を決める
2. カットオフ周波数、必要な遷移域幅を決める
3. 次数を決める
4. 設計コードで設計する
5. 周波数特性、遅延グラフ、極のグラフ、時系列グラフで問題ないか確認して完成


Pythonライブラリでフィルタを設計すると簡単にフィルタ係数を求められるのでおすすめです。<br>
求めているフィルタの条件が厳しい時、ただ設計定数を入れるだけでは、フィルタが共振したり、条件を満たさない出力が出てくるので、その場合は、阻止域端最小減衰、遷移幅、通過域端などの値をいくつか与えて総当たりすることで最適なフィルタを見つけることが可能です。